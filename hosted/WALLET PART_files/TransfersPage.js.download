define("mobile/pages/payments/transfers/TransfersRouter",["BackboneX"],function(e){var t=e.Router.extend({routes:{"step=:step":"_switchToStep"},initialize:function(t){this._super(),this._workflow=t.workflow,e.history.start(),this._handleWorkflow()},_handleWorkflow:function(){this._workflow.on("switchToStep",this._onSwitchToStep,this).on("success",this._onWorkflowSuccess,this)},_switchToStep:function(e){this._workflow.switchToStep(e)},_onSwitchToStep:function(e){this.navigate("step="+e)},_onWorkflowSuccess:function(){e.history.stop()}});return t}),define("global/WorkflowClasses/WorkflowModel",["BackboneX"],function(e){var t=e.Model.extend({});return t}),define("mobile/pages/payments/transfers/workflow/TransfersWorkflowModel",["global/WorkflowClasses/WorkflowModel"],function(e){var t=e.extend();return t}),define("global/WorkflowClasses/WorkflowView",["underscore","BackboneX","./WorkflowModel"],function(e,t,n){var r=t.View.extend({_ModelConstructor:n,_initProperties:function(){this._super(),this._page=this.options.page,this.model=this.options.model||new this._ModelConstructor,this._steps=[],this._currentStepIndex=this.options.currentStep||0,this._tabs=this.options.tabs},initialize:function(){this._super(),this._updateModelData(),this._initSteps(),this._initTabs()},_updateModelData:function(){},_initSteps:function(){this._steps=this._getSteps(),this._steps.forEach(this._initStep,this),this._steps[this._steps.length-1].on("release",this._onLastStepRelease,this)},_initStep:function(e,t){e.on("next",this._onStepPerformed,this),e.on("prev",this.prev,this),e.model.formFields.on("change",this._markStepAsChanged.bind(this,t)),e.on("changeEnabled",this._onStepChangeEnabled.bind(this,e))},_initTabs:function(){this._tabs.on("change",this._onTabChange,this)},_onTabChange:function(e){this.switchToStep(e)},getCurrentStep:function(){return this._steps[this._currentStepIndex]},getPrevStep:function(){return this._currentStepIndex?this._steps[this._currentStepIndex-1]:null},_getSteps:function(){return[]},_onStepPerformed:function(e,t){this._currentStepIndex==this._steps.length-1?this._success():(this._disableStepsAfter(this._currentStepIndex),this.switchToStep(this._currentStepIndex+1,!0))},next:function(e,t){this._onStepPerformed(e,t)},prev:function(){this.switchToStep(this._currentStepIndex-1,!0)},getStep:function(e){return typeof e=="string"&&(e=this._getStepNumber(e)),e<0||e>=this._steps.length?null:this._steps[e]},switchToStep:function(e,t){var n=this.getStep(e);if(!n||n===this._steps[this._currentStepIndex])return;var r=this._getStepNumber(e),i=this._steps.slice(0,r).some(function(e){return e.changed});if(i)return;var s=this.getCurrentStep();s.leave(),(!n.isEnabled()||t)&&n.enable(),typeof e=="string"&&(e=this._getStepNumber(e)),this._currentStepIndex=e;var o=n.getName();this.trigger("switchToStep",o),this._tabs.show(o)},_markStepAsChanged:function(e){this._steps[e].changed=!0,this._disableStepsAfter(e)},_disableStepsAfter:function(e){var t=this._steps.length;for(var n=e+1;n<t;n++)this._steps[n].disable()},_getStepNumber:function(t){var n=0;return e(this._steps).some(function(e,r){return e.getName()===t?(n=r,!0):!1}),n},_onStepChangeEnabled:function(e){var t=e.getName();e.isEnabled()?this._tabs.enableTab(t):this._tabs.disableTab(t)},_onLastStepRelease:function(){this._tabs.enable()},_success:function(){this.trigger("success"),this._tabs.disable(),this.getCurrentStep().freeze()}});return r}),define("global/WorkflowClasses/StepModel",["global_forms/Form/Ajax/AjaxFormModel"],function(e){var t=e.extend({initialize:function(){this._super(),this._workflow=null},setWorkflow:function(e){this._workflow=e,this._initValidation(),this._processFields()},_initValidation:function(){},_processFields:function(){this.eachField(function(e){e.link(this._setModelAttributes.bind(this))}.bind(this))},_setModelAttributes:function(e){this._workflow.set(e.get("name"),e.getPostValue())}});return t}),define("global/WorkflowClasses/StepView",["global_forms/Form/Ajax/AjaxFormView","./StepModel"],function(e,t){var n=e.extend({_ModelConstructor:t,_submitName:"next",_initProperties:function(){this._super(),this._enabled=!1,this._page=this.options.page,this.changed=!1},_initHandlers:function(){this._super();var e=this.getField("back");e&&e.on("click",this._prev,this)},getName:function(){var e=this.model.get("name");if(!e)throw new Error("Please specify the form name attribute for all forms involved in workflow");return e},isEnabled:function(){return this._enabled},enable:function(){return this._enabled=!0,this.trigger("changeEnabled"),this},disable:function(){return this._enabled=!1,this.trigger("changeEnabled"),this},freeze:function(){var e=this.getField("back");return e&&e.disable(),this},release:function(){var e=this.getField("back");return e&&e.enable(),this.trigger("release"),this},_prev:function(){this.trigger("prev")},done:function(e){this.changed=!1,this.trigger("next",this,e)},leave:function(){this.model.abortAllQueries()},_processSaveSuccess:function(e){this._super(e),this.done(e)}});return n}),define("elements/StateMapper/Simple/StateMapperSimpleModel",["BackboneX"],function(e){var t=e.Model.extend();return t}),define("elements/StateMapper/Simple/StateMapperSimpleView",["BackboneX","underscore.string","./StateMapperSimpleModel"],function(e,t,n){var r=e.View.extend({initialize:function(){this._super(),this._dashedMap={},this._initModel(),this._handleModel()},_initModel:function(){this._model=this.options.model||this._getDefaultModel()},_getDefaultModel:function(){return new n},_handleModel:function(){this._model.on("change",this._render,this)},_getDashed:function(e){var n=this._dashedMap[e]||t.dasherize(e).replace(/\./g,"-");return this._dashedMap[e]=n,n},_buildMappedClass:function(e,t){return"js-"+e+"-"+t},_getClassFromElement:function(e){var t=this.$el.attr("class").match(this._buildMappedClass(e,"")+"[\\w-]*");return t?t.join(" "):""},_render:function(){var n=this._model.previousAttributes(),r=this._model.changedAttributes();t(r).each(function(e,t){var r=this._getDashed(t),i=n[t],s=this._buildMappedClass(r,this._getDashed(e)),o=i!==undefined?this._buildMappedClass(r,this._getDashed(i)):this._getClassFromElement(r);this.$el.removeClass(o).addClass(s)},this),e.trigger("change:visibility")}});return r}),define("elements/StateMapper/Form/StateMapperFormModel",["../Simple/StateMapperSimpleModel"],function(e){var t=e.extend({handleField:function(e){e.link(this._onFieldChange,this)},_onFieldChange:function(e){this.set(e.get("name"),e.getStringValue(this._format))},_format:function(e){return e.join("")}});return t}),define("elements/StateMapper/Form/StateMapperFormView",["underscore","../Simple/StateMapperSimpleView","./StateMapperFormModel"],function(e,t,n){var r=t.extend({_classes:function(){return e.defaults({field:"state-mapper__field"},this._super())},handleForm:function(e){e.getFieldsInside().filter(this._fieldFilter,this).forEach(this.handleField,this)},_getDefaultModel:function(){return new n},_fieldFilter:function(e){return e.$el.hasClass(this._class("field"))},handleField:function(e){this._model.handleField(e.model)},handleForms:function(e){e.forEach(this.handleForm,this)}});return r}),define("FormClasses/Form/StateMapper/FormViewWithStateMapper",["elements/StateMapper/Form/StateMapperFormView"],function(e){var t={initialize:function(){this._super(),this._initStateMapper()},_stateMapperModel:null,_initStateMapper:function(){var t=new e({el:this._getStateMapperEl(),model:this._stateMapperModel});t.handleForm(this),this._stateMapper=t},_getStateMapperEl:function(){return this.$el}};return t}),define("mobile/pages/payments/transfers/workflow/steps/TransferStepModel",["underscore","global/WorkflowClasses/StepModel"],function(e,t){var n=t.extend({_queries:function(){return e.defaults({validate:this._validationQuery},this._super())},_validationQuery:function(e){this._sendQuery("validate",e)},_getFieldsConfiguration:function(){return{"*":{validation:["not-empty"]},next:this._NO_VALIDATION,back:this._NO_VALIDATION}},onSkip:function(){}});return n}),define("mobile/pages/payments/transfers/workflow/steps/TransferStepView",["underscore","global/WorkflowClasses/StepView","FormClasses/Form/StateMapper/FormViewWithStateMapper","./TransferStepModel"],function(e,t,n,r){var i=t.mix(n).extend({_ModelConstructor:r,_initHandlers:function(){this._super(),this.model.on("validate:error",this._processValidationError,this)},_sendForm:function(){this.model.query("validate")},_submitName:"next",_processValidationError:function(){this.enableSubmitButton()},_getErrorParams:function(t){return e({messages:t.messages}).defaults(this._super.apply(this,arguments))},correctFocus:function(){var t=e(this._fields).find(function(e){return e.isVisible()&&!e.isDisabled()});if(!t)return this;var n=this.getField("back"),r=this.getField("next");return r&&n&&t==n?r.focus():t.focus(),this},_processSaveSuccess:function(e){var t=this.model._workflow.attributes.transferType,n=this.getName(),r=t+"_"+n+"_continue_clicked";window.mParticle&&window.mParticle.logEvent(r,window.mParticle.EventType.Other),this._super(e)}});return i}),define("global/urlQueryParams",[],function(){var e=document.location.search,t={};e.indexOf("?")===0?e=e.substr(1):e="";if(e.length){var n=e.split("&");for(var r=0,i=n.length;r<i;r++){var s=n[r].split("=");t[s[0]]=s[1]}}return t}),define("mobile/pages/payments/transfers/workflow/steps/first/BaseInfoStepModel",["underscore","../TransferStepModel","global/elements/ServiceManager/WithServiceManager","global/urlQueryParams"],function(e,t,n,r){var i=t.mix(n).extend({defaults:function(){return e({scenario:"default"}).defaults(this._super())},initialize:function(){this._super(),this._accountRequests={}},_urls:function(){var t=this._getService("urls");return e.defaults({allAccounts:t.get("gtt_payment_get_accounts"),sourceAccounts:t.get("gtt_payment_get_src_accounts"),destinationAccounts:t.get("gtt_payment_get_dst_accounts"),getFields:t.get("gtt_payment_get_fields"),validate:t.get("gtt_payment_validate_direction")},this._super())},_processFields:function(){this._super(),this.getField("transferType").on("change:value",this._onChangeTransferType,this),this.getField("sourceAndSourceCurrency").on("change:value",this._onChangeSourceAndSourceCurrency,this),this.getField("destinationAndDestinationCurrency").on("change:value",this._onChangeDestinationAndDestinationCurrency,this)},_onChangeTransferType:function(){["sourceAndSourceCurrency","destinationAndDestinationCurrency"].forEach(function(e){this.getField(e).value("")},this),this._queryAccounts()},_queryAccounts:function(){e(this._accountRequests).each(function(e){e.abort()}),this._accountRequests.allAccounts=this._sendQuery("allAccounts",{type:"post",data:this._getParamsForAccountsQuery()})},_getParamsForAccountsQuery:function(){return{transfer_type:this.getField("transferType").getPostValue(),payment_token:this._workflow.get("paymentToken")}},_onChangeSourceAndSourceCurrency:function(){var e=this._getSourceData();if(!e)return;this._updateFieldFromServer("destinationAccounts",e)},_onChangeDestinationAndDestinationCurrency:function(){var e=this._getDestinationData();if(!e)return;this._updateFieldFromServer("sourceAccounts",e)},_getSourceData:function(){var e=this.getField("sourceAndSourceCurrency").getAccountData();return e&&{src_account:e}},_getDestinationData:function(){var e=this.getField("destinationAndDestinationCurrency").getAccountData();return e&&{dst_account:e}},_updateFieldFromServer:function(t,n){n=e(n).defaults(this._getParamsForAccountsQuery());var r=this._accountRequests;r[t]&&r[t].abort(),r[t]=this._sendQuery(t,{type:"post",data:n})},_validationQuery:function(){var t=this._getSourceData(),n=this._getDestinationData(),r=this._getParamsData(),i=this._dataToSend=e.extend(this._getParamsForAccountsQuery(),t,n,r);this._super({type:"post",data:i})},_getParamsData:function(){var e={};return r.appinstallationid&&(e.appinstallationid=r.appinstallationid),e},_getFullName:function(e){var t=this.getField(e).getFirstInput(),n=t.getDataForCurrentValue("frontName");return(n?n+" ":"")+t.getDataForCurrentValue("name")},save:function(){var t=this._getFullName("source"),n=this._getFullName("destination"),r=e(this._dataToSend).extend({src_name:t,dst_name:n});return this._workflow.set({baseInfo:r,srcName:t,dstName:n}),this._sendQuery("save",{url:this._url("getFields"),data:r}),this},onSkip:function(){var t=this._getFullName("source"),n=this._getFullName("destination");this._workflow.set("baseInfo",e.extend({src_name:this._getFullName("source"),dst_name:this._getFullName("destination"),transfer_type:this.getField("transferType").getPostValue(),payment_token:this._workflow.get("paymentToken")},this._getSourceData(),this._getDestinationData())),this._workflow.set("srcName",t),this._workflow.set("dstName",n)}});return i}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this==null)throw new TypeError("Array.prototype.find called on null or undefined");if(typeof e!="function")throw new TypeError("predicate must be a function");var t=Object(this),n=t.length>>>0,r=arguments[1],i;for(var s=0;s<n;s++)if(s in t){i=t[s];if(e.call(r,i,s,t))return i}return undefined}}),define("vendors/shim/find",function(){}),define("mobile/pages/payments/transfers/fields/AccountAndCurrencyFieldModel",["global_forms/Fields/FormField/FormFieldModel","vendors/shim/find"],function(e){var t=e.extend({linkInputs:function(){return this.getInputByNumber(0).on("change:data",this._updateCurrency,this).link(this._updateCurrency,this),this},_updateCurrency:function(){var e=this.getInputByNumber(0),t=this.getInputByNumber(1);e.value()===""&&t.value("");var n=this._getAccountsList().map(function(e){return e.currencyId+""});n.length===1&&t.setDefaultValue(n[0]),t.allowValues(n)},getPostValue:function(){return this._retrieveAccounts(Array.prototype.filter)},getAccountData:function(){return this._retrieveAccounts(Array.prototype.find)},_retrieveAccounts:function(e){var t=this.getInputByNumber(1),n=parseInt(t.value(),10);return isNaN(n)?[]:e.call(this._getAccountsList(),function(e){return e.currencyId===n})||null},_getAccountsList:function(){var e=this.getInputByNumber(0),t=[];if(e.value()=="all")e.forEachDataValue("accounts",function(e){e&&t.push.apply(t,e)});else{var n=e.getDataForCurrentValue();n.children?n.children.forEach(function(n){var r=e.getDataForValue(n,"accounts");r&&t.push.apply(t,r)}):n.accounts&&(t=n.accounts)}return t}});return t}),define("mobile/pages/payments/transfers/fields/AccountAndCurrencyFieldView",["underscore","global_forms/Fields/FormField/FormFieldView","./AccountAndCurrencyFieldModel"],function(e,t,n){var r=t.extend({_selectors:function(){return e.defaults({comment:".js-hint-comment",currencyLabel:".subject__label"},this._super())},_ModelConstructor:n,_initInputs:function(){this._super();var e=this.getInputByNumber(0),t=this.getInputByNumber(1);e.model.on("change:value",this._onSelectInputChange,this),t.model.on("allowedValues",this._checkCurrencyAvailability,this),this.model.linkInputs(),this.checkCurrencyVisibility()},_onSelectInputChange:function(e){var t=e.getDataForCurrentValue(),n=t&&t.comment?t.comment:null;n?this._removeClass("hidden","comment").html(n):this._addClass("hidden","comment")},_checkCurrencyAvailability:function(e){var t=this.getInputByNumber(1);e&&e.length<=0?t.disable():t.enable()},checkCurrencyVisibility:function(){var e=this.getInputByNumber(0),t=!e.getData("showCurrency");return this._toggleClass("hidden","currencyLabel",t),this._toggleClass("hidden",this.getInputByNumber(1).$el,t),this}});return r}),define("mobile/pages/payments/transfers/workflow/steps/first/BaseInfoError",["vendors/Backbone/Mixin"],function(e){var t=new e({_initProperties:function(){this._super(),this._messages=this.options.messages},_statuses:{400:{PAYMENT_ERROR:{DIRECTION_VALIDATE_ERROR:function(){this._form.showNotification("errors",this._messages.join(""))}}}}});return t}),define("mobile/pages/payments/transfers/workflow/steps/WithNotifications",["underscore","vendors/Backbone/Mixin","global/elements/ServiceManager/WithServiceManager"],function(e,t,n){var r=new t({dependencies:[n]},{_selectors:function(){return e.defaults({notification:".js-notification",notificationName:".js-notification-%s",notificationHolder:".js-notification-holder"},this._super())},_initHandlers:function(){this._super(),this.model.on("change:scenario",this._onChangeScenario,this)},_onChangeScenario:function(e,t){t==="default"&&(this._initStatusConditions(),this.hideNotifications())},_processTransferWarnings:function(e){var t=e.warnings||e.data&&e.data.warnings;t.length?(this.showNotification("warnings",t[0]),this.model.get("scenario")!=="fulfilled"&&this.model.set("scenario","warnings"),this.enableSubmitButton()):this.model.save()},_reset:function(e){this.hideNotifications(),this._super(e)},showNotification:function(e,t){this.hideNotifications();var n=this._elem("notificationName",e);return t&&n.find(this._selector("notificationHolder")).html(t),this._removeClass("hidden",n),this._getService("viewport").scrollTo(n),this.model.formFields.on("change:value",this._onFormFieldChange,this),this},hideNotifications:function(){return this.model.formFields.off("change:value",this._onFormFieldChange,this),this._addClass("hidden","notification"),this},_onFormFieldChange:function(){this.model.set("scenario","default")},done:function(e){this._super(e),this.model.set("scenario","default")}});return r}),define("global_forms/Validation/FilesFieldValidator",["global_forms/Validation/FormFieldValidator"],function(e){var t=e.extend({_initProperties:function(){this._super(),this._extensions=[],this._maxSize=Infinity},_checkFileSize:function(e){return!e.size||e.size<this._maxSize},_checkFileExt:function(e){var t=e.split(".").pop();return!this._extensions.length||this._extensions.indexOf(t.toLowerCase())>-1},addExtensionAndSizeValidationRule:function(e,t,n){return this._extensions=t,this._maxSize=n,this.addRule(e,this._checkFileExtensionsAndSize),this},_checkFileExtensionsAndSize:function(e,t){this._errorData={};var n=!1,r=e.map(function(e){if(!e)return!0;var t=this._checkFileExt(e.name);return e.files&&e.files.length&&(t=t&&this._checkFileSize(e.files[0])),t||(n=!0),t},this);return t.set("wrongFiles",r),n&&(this._errorData={hint:[t.getWrongFilesNames(e,r).join(", ")]}),!n},isEmptyValue:function(e){return!e.length||!e.some(function(e){return e})}});return t}),define("global_forms/Fields/Files/FilesFieldModel",["underscore","global_forms/Fields/FormField/FormFieldModel","global_forms/Validation/FilesFieldValidator"],function(e,t,n){var r=t.extend({_validator:new n,defaults:function(){return e.extend({wrongFiles:[],wrongFileNames:[]},this._super())},initialize:function(){this._super(),this._inputs.on("remove",this._onInputRemove,this)},_onInputRemove:function(e,t,n){var r=this.get("wrongFiles");r.splice(n.index,1),this._inputs.add(e),this._updateValue()},_updateValue:function(e){var t=this._getInputValues(),n=this.get("wrongFiles");n=n.map(function(e,n){return t[n]?e:!0}),this.set({value:t,wrongFiles:n},e)},addInput:function(e){var t=this.get("wrongFiles");return t.push(!0),this._super(e)},getWrongFilesNames:function(e,t){return e=e||this.value(),t=t||this.get("wrongFiles"),e.filter(function(e,n){return!t[n]}).map(function(e){return e.name})},setErrorData:function(e){var t=this.get("wrongFiles"),n=e.length,r=t.length;if(n<r)for(var i=n;i<r-1;i++)e.push(!0);this.set("wrongFiles",e)}});return r}),define("global_forms/Form/File/WithAjaxFilesFormModel",["global_forms/Fields/Files/FilesFieldModel"],function(e){var t={_initProperties:function(){this._super(),this._transport={save:function(){throw new Error("Transport for AjaxFilesForm is not defined")}}},save:function(e,t){return this._super(e,t,this._transport)},_buildQueryData:function(t,n){var r=this._super(t,n),i={};for(var s in r){if(!r.hasOwnProperty(s)||i[s]!==undefined)continue;var o=this.getField(s);o instanceof e||(i[s]=r[s])}return i},setTransport:function(e){this._transport=e}};return t}),define("global_forms/Form/File/AjaxFilesFormModel",["global_forms/Form/Ajax/AjaxFormModel","./WithAjaxFilesFormModel"],function(e,t){var n=e.mix(t);return n}),define("global_forms/Form/File/AjaxFilesFormError",["vendors/Backbone/Mixin"],function(e){var t=new e({_codes:{UPLOAD_ERROR:function(){this._showFileFieldError()}},_statuses:{413:function(){this._showFileFieldError()}},_fileField:"files",_initProperties:function(){this._super(),this._fileNames=this.options.files||[]},_showFileFieldError:function(){this._form.model.getField(this._fileField).setErrorData(this._fileNames),this._form.showFieldError(this._fileField,"not-correctly-file")}});return t}),define("global_forms/Inputs/File/FileInputModel",["global_forms/Inputs/Abstract/AbstractInputModel"],function(e){var t=e.extend({_initProperties:function(){this._super(),this._convertValueToString=!1},initialize:function(){this._super(),this.on("destroy",this.clearValue,this)}});return t}),define("global_forms/Inputs/File/FileInputView",["underscore","vendors/jquery/plugins/jquery.form","global_forms/Inputs/Abstract/AbstractInputView","./FileInputModel"],function(e,t,n,r){var i=n.extend({_selectors:function(){return e.defaults({fileName:".file__name",input:".file__input"},this._super())},_classes:function(){return e.defaults({focus:"file_focus_yes",disabled:"file_disabled_yes"},this._super())},_ModelConstructor:r,events:function(){var e=this._super();return e.change=this._tryToChangeValueByUser,e},initialize:function(){this._super(),this._elem("fileName").length&&this.model.on("change:value",this._updateFileName,this),navigator.userAgent.indexOf(" OS 8_")!==-1&&this._elem("input").attr("multiple","")},_updateFileName:function(e,t){this._elem("fileName").val(t&&t.name||"")},_getValue:function(){var e=this.$input[0];return e.value?{files:e.files,name:e.value.replace(/.*\\/,"")}:null},_setValue:function(e){e||this._clearInput()},_clearInput:function(){this.$input.clearInputs(),this._dropElemCache("input"),this.$input=this.getInput()}});return i}),define("vendors/twig/TwigRender",["underscore.string","Twig","vendors/twig/twigFilters","vendors/twig/twigTests"],function(e,t){var n={_macro:function(n,r,i){return e.trim(t.macro.apply(t,arguments).replace(/\s+/g," "))},_render:function(n,r){return e.trim(t.render(n,r).replace(/\s+/g," "))}};return n}),define("global_forms/Fields/Files/FilesFieldView",["jquery","underscore","global_forms/Fields/FormField/FormFieldView","./FilesFieldModel","global_forms/Inputs/inputsFactory","global_forms/Inputs/File/FileInputView","vendors/twig/TwigRender","FileListTemplate"],function(e,t,n,r,i,s,o,u){var a=n.mix(o).extend({_ModelConstructor:r,_classes:function(){return t.defaults({emptyInput:"file__input_active_yes",fileInputsHolder:"file",fileInputsList:"file__inputs",fileDisabled:"file_disabled_yes",fileFocused:"file_focus_yes"},this._super())},_selectors:function(){return t.defaults({titles:".file__list",cleaner:".file__cleaner"},this._super())},events:function(){var e={};return e["click "+this._selector("cleaner")]=this._cleanFileInput,e},_initProperties:function(){this._super(),this._emptyInputIndex=0,this._statusConditions="focus blur success error change:error",this._hintConditions="focus error change:error"},initialize:function(){this._super(),this.model.on("change:value",this._onValueChange,this)},_addInput:function(e){this._super(e),e.on("change:value:byUser",this._focusEmptyInput,this),e.model.on("remove",this._onInputRemove,this)},_onInputRemove:function(e,t,n){var r=this._inputs.splice(n.index,1)[0];this._inputs.push(r),r.$el.appendTo(this._elem("fileInputsList")),this._setEmptyInput()},_onValueChange:function(e,t){this._renderFileList(t),this._setEmptyInput()},_renderFileList:function(t){var n={items:e.map(t,function(e,t){return e?{name:e.name,index:t}:null})},r=this._render(u,n);this._replaceElem("titles",r)},_cleanFileInput:function(t){t.preventDefault(),this.status.ignore("not-empty");var n=e(t.currentTarget);this._inputs[n.data("inputIndex")].model.destroy(),this._focusEmptyInput()},_setEmptyInput:function(){var e=-1;for(var t=0;t<this._inputs.length;t++)this._inputs[t].$input.attr("tabindex",-1).removeClass(this._class("emptyInput")),e===-1&&!this._inputs[t].model.value()&&(e=t);e<0?this._elem("fileInputsHolder").addClass(this._class("fileDisabled")):(this._elem("fileInputsHolder").removeClass(this._class("fileDisabled")),this._inputs[e].$input.attr("tabindex",0).addClass(this._class("emptyInput"))),this._emptyInputIndex=e},_focusEmptyInput:function(){this._emptyInputIndex!==-1&&this._inputs[this._emptyInputIndex].$input.focus()},_onFocus:function(e,t){this._super(e,t),this._elem("fileInputsHolder").addClass(this._class("fileFocused"))},_onBlur:function(e,t){this._super(e,t),this._elem("fileInputsHolder").removeClass(this._class("fileFocused"))}});return i.addProduct("FileInput",s),a}),define("mobile/FormClasses/Fields/Files/FilesFieldView",["global_forms/Fields/Files/FilesFieldView"],function(e){return e.extend({_initProperties:function(){this._super(),this._statusConditions="success error change:error"}})}),define("global_forms/Form/File/WithAjaxFilesFormView",["underscore","./AjaxFilesFormModel","./AjaxFilesFormError","global_forms/Fields/fieldFactory","global_forms/Fields/Files/FilesFieldView","Modernizr","vendors/jquery/plugins/jquery.form"],function(e,t,n,r,i,s){var o={_ModelConstructor:t,_getErrorMixins:function(){return this._super().concat([n])},_fileFieldName:"files",_initProperties:function(){this._super(),this._clearFileFieldOnSubmit=!0},_handleModel:function(){this._super(),this.model.setTransport(this)},save:function(e){var t=!1;if(!s.filereader){var n=this.getField(this._fileFieldName);t=n&&!n.model.isEmpty()}e.iframe=t;if(t){var r=e.success,i=e.error;e.dataType="json",e.success=function(e,t,n){typeof e.success!="undefined"&&e.success===!0?r(e,t,n):i(n,"error")}}return this.$el.ajaxSubmit(e),this.$el.data("jqxhr")},_clearFileField:function(){var e=this.getField(this._fileFieldName);e&&this._clearFileFieldOnSubmit&&(e.status.ignore("not-empty"),e.model.clearValue())},_processSaveSuccess:function(e){this._super(e),this._clearFileField()},_getErrorParams:function(t){return e({files:t.files}).defaults(this._super.apply(this,arguments))}};return r.addProduct("FilesField",i),o}),define("global_forms/Form/File/AjaxFilesFormView",["global_forms/Form/Ajax/AjaxFormView","./WithAjaxFilesFormView"],function(e,t){var n=e.mix(t);return n}),define("mobile/pages/payments/transfers/workflow/steps/first/DocumentsFormView",["underscore","global_forms/Form/File/AjaxFilesFormView"],function(e,t){var n=t.extend({_selectors:function(){return e.defaults({buttons:".js-buttons",documentsLoadedSuccess:".js-documents-loaded-success"},this._super())},_submitName:"sendDocuments",initialize:function(){this._super(),this._cancelButton=this.getField("cancel"),this._cancelButton.on("click",this._onCancelButtonClick,this),this.getField(this._fileFieldName).model.on("change:value",this._onFilesFieldValueChange,this),this.getField("document").model.on("change:value",this._onDocumentChange,this),this.getField(this._submitName).on("click",this._submit,this)},_onCancelButtonClick:function(e){this.model.abortQuery("save"),this._clearFileField()},_onFilesFieldValueChange:function(e){this._elem("buttons").toggleClass(this._class("hidden"),e.isEmpty())},_onDocumentChange:function(){this.getField(this._fileFieldName).status.ignore("not-empty").show("check")},_processSaveSuccess:function(e){this._super(e),this._removeClass("hidden","documentsLoadedSuccess")},_processSaveError:function(e,t){this._super(e,t),this._addClass("hidden","documentsLoadedSuccess")}});return n}),define("vendors/Modernizr/modernizr.fileinput",["Modernizr"],function(e){e.addTest("fileinput",function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled})}),define("mobile/pages/payments/transfers/workflow/steps/first/BaseInfoStepView",["jquery","underscore","../TransferStepView","global/elements/ServiceManager/WithServiceManager","./BaseInfoStepModel","../../../fields/AccountAndCurrencyFieldView","global_forms/Fields/fieldFactory","./BaseInfoError","../WithNotifications","./DocumentsFormView","Modernizr","vendors/Modernizr/modernizr.fileinput"],function(e,t,n,r,i,s,o,u,a,f,l){var c=n.mix(a,r).extend({_ModelConstructor:i,_selectors:function(){return t.defaults({forbiddenContainer:".js-forbidden-container",forbiddenInfo:".js-forbidden-info",documentsFormHolder:".js-documents-form-holder",accordionGroup:".accordion__group",accordionContent:".accordion__content",otherMethod:".js-other-method",uploadDocuments:".js-upload-documents",showUploadDocuments:".js-show-upload-documents",optionTextApplePay:".option__text_apple-pay"},this._super())},_classes:function(){return t.defaults({accordionGroupActive:"accordion__group_active_yes"},this._super())},events:function(){var e=this._super();return e["click "+this._selector("otherMethod")]=this._onOtherMethodClick,e["click "+this._selector("uploadDocuments")]=this._onUploadDocumentsClick,e["click "+this._selector("showUploadDocuments")]=this._onShowUploadDocumentsClick,e},_initProperties:function(){this._super(),this._checkApplePay(),this._documentsForm=null},_getStateMapperEl:function(){return this.$el.closest(".transfers")},_initHandlers:function(){this._super(),this.model.on("save:request",this._processSaveRequest,this).on("allAccounts:request",this._processAllAccountsRequest,this).on("allAccounts:success",this._processAllAccountsQueryComplete,this).on("allAccounts:error",this._processAllAccountsError,this).on("sourceAccounts:request",this._onSourceAccountsAndDestinationAccountsRequest.bind(this,"sourceAndSourceCurrency")).on("sourceAccounts:success",this._onCompleteUpdateField.bind(this,"sourceAndSourceCurrency")).on("sourceAccounts:error",this._onErrorUpdateField.bind(this,"sourceAndSourceCurrency")).on("destinationAccounts:request",this._onSourceAccountsAndDestinationAccountsRequest.bind(this,"destinationAndDestinationCurrency")).on("destinationAccounts:success",this._onCompleteUpdateField.bind(this,"destinationAndDestinationCurrency")).on("destinationAccounts:error",this._onErrorUpdateField.bind(this,"destinationAndDestinationCurrency")).on("validate:success",this.processValidationSuccess,this).on("validate:error",this._processValidationError,this),this.getField("destination").getFirstInput().on("toggleEnabled",this._onDestinationToggleEnabled,this),this.getField("transferType").model.on("change:value",this._onChangeTransferType,this)},_onDestinationToggleEnabled:function(e,t){this.getField("destination").toggleEnabled(t)},_onChangeTransferType:function(){var e=this._getService("viewport"),t=e.scrollTop(),n=e[0].scrollHeight;this._removeClass("accordionGroupActive","accordionGroup"),this._elem("accordionContent").css("display",""),e.scrollTop(t+(e[0].scrollHeight-n))},_processAllAccountsError:function(){this._onErrorUpdateField("sourceAndSourceCurrency"),this._onErrorUpdateField("destinationAndDestinationCurrency")},_onErrorUpdateField:function(e){this.getField(e).getFirstInput().stopLoading()},_processSaveRequest:function(){this._loadSubmitButton()},_processAllAccountsRequest:function(){this._onStartUpdateField("sourceAndSourceCurrency"),this._onStartUpdateField("destinationAndDestinationCurrency")},_onSourceAccountsAndDestinationAccountsRequest:function(e){this._onStartUpdateField(e)},_processAllAccountsQueryComplete:function(t){var n=e(t);this._onCompleteUpdateField("sourceAndSourceCurrency",n.eq(0)),this._onCompleteUpdateField("destinationAndDestinationCurrency",n.eq(2))},_onStartUpdateField:function(e){this.getField(e).getFirstInput().startLoading()},_onCompleteUpdateField:function(e,t){var n=this.getField(e);n.getFirstInput().stopLoading().updateFrom(t),e==="destinationAndDestinationCurrency"&&this._checkForbiddenInfo(t),n.checkCurrencyVisibility()},_checkForbiddenInfo:function(t){var n=e(t),r=n.filter(this._selector("forbiddenInfo"));if(!r.length){this._addClass("hidden","forbiddenContainer");return}this._removeClass("hidden","forbiddenContainer"),this._elem("forbiddenContainer").empty().append(r)},_submit:function(e){this.model.hasActiveQueries()?(e.preventDefault(),this._loadSubmitButton(),this.model.once("allQueries:complete",this._submit.bind(this,e))):this.model.get("scenario")==="warnings"?(e.preventDefault(),this.model.save()):this.model.get("scenario")==="fulfilled"?(e.preventDefault(),this.model.onSkip(),this.done()):(this.enableSubmitButton(),this._super(e))},processValidationSuccess:function(e){this._processTransferWarnings(e)},_processSaveSuccess:function(e){["destinationAndDestinationCurrency","sourceAndSourceCurrency"].forEach(function(e){this.getField(e).status.reset()},this),this._super(e)},_getErrorMixins:function(){return this._super().concat([u])},showNotification:function(e,t){return this._documentsForm&&(this._addClass("hidden","documentsFormHolder"),this._documentsForm.model.reset()),e==="warnings"&&this._initDocumentsForm(),this._super(e,t)},_initDocumentsForm:t.method.once(function(){var e=this._documentsForm=new f({el:document.forms.documents});this._removeClass("hidden",e.$el),this._elem("documentsFormHolder").append(e.$el),e.model.on("save:success",this._onDocumentsFormSaveSuccess,this)}),_onDocumentsFormSaveSuccess:function(){this.showNotification("upload-success")},_onOtherMethodClick:function(){this._getService("viewport").scrollTo(this.$el),this.hideNotifications(),this.model.set("scenario","default")},_onUploadDocumentsClick:function(){l.fileinput?this._toggleClass("hidden","documentsFormHolder"):this.showNotification("upload-error")},_onShowUploadDocumentsClick:function(){this.showNotification("warnings"),this._removeClass("hidden","documentsFormHolder")},_checkApplePay:function(){window.ApplePaySession&&window.ApplePaySession.canMakePayments()&&this._findElem("optionTextApplePay").css("display","block")}});return o.addProduct("AccountAndCurrencyField",s),c}),define("mobile/pages/payments/transfers/workflow/steps/second/behaviors/FillBehavior",["BackboneX","underscore","global/elements/Queries/Queries"],function(e,t,n){var r=e.Model.mix(n).extend({initialize:function(){this._super(),this._form=this.get("form"),this._triggeringFields=this.get("triggeringFields"),this._receivingFields=this.get("receivingFields"),this._updateFieldsUrl=this.get("url"),this._strategy=this.get("strategy"),this._queryParams=this.get("queryParams"),this._updating=!1,this._updateFieldsDelay=200,this._initHandlers()},_initHandlers:function(){this._triggeringFields.forEach(this._handleField.bind(this)),this.on("updateFields:success",this._processUpdatingFieldSuccess).on("updateFields:error",this._processUpdatingFieldError)},_handleField:function(e){var n=this._form.getField(e),r=t.debounce(this._updateReceivingFields.bind(this,n),this._updateFieldsDelay);n.link(this._onChangeField.bind(this,n,r))},_onChangeField:function(e,t){if(this._updating)return;this.abortQuery("updateFields"),e.isValid()?t():this._behaviorError()},_updateReceivingFields:function(e){if(!e.isValid())return;this.trigger("behavior:fieldsRequest",t(this._receivingFields).without(e.get("name"))),this._sendQuery("updateFields",{url:this._updateFieldsUrl,type:this._getMethod(),data:this._getQueryParams(e)})},_getQueryParams:function(e){var n=t.clone(this._queryParams);return n.field=e.get("name"),n.value=e.getPostValue(),n.strategy=this._strategy,n},_getMethod:function(){return"get"},_processUpdatingFieldSuccess:function(e){this._setFieldsValues(e)},_processUpdatingFieldError:function(e,t){t.status!==0&&this._behaviorError()},_behaviorError:function(){this.trigger("behavior:error",this._receivingFields)},_setFieldsValues:function(e){this._updating=!0,this._receivingFields.forEach(function(n){var r=e[n],i=this._form.getField(n);if(!i){console.warn(t("Field %s does not found").s(n));return}r?i.value(r):i.clearValue()},this),this.trigger("behavior:fieldsUpdated",this._receivingFields),this._updating=!1}});return r}),define("mobile/pages/payments/transfers/workflow/steps/second/behaviors/AutocompleteBehavior",["jquery","underscore","./FillBehavior"],function(e,t,n){var r=n.extend({initialize:function(){this._super(),this._queryParams=this.get("queryParams")},_initHandlers:function(){this._super(),this.on("updateFields:request",this._processUpdatingFieldRequest,this)},_processUpdatingFieldRequest:function(){this._receivingFields.forEach(function(e){})},_handleField:function(e){var n=this._form.getField(e),r=t.debounce(this._updateReceivingFields.bind(this,n),this._updateFieldsDelay);n.on("change:value",this._onChangeField.bind(this,n,r))},_getQueryParams:function(e){var n=t.clone(this._queryParams);n[e.get("name")]=e.getPostValue();var r=n.additional_data={};return this._form.eachField(function(e){r[e.get("name")]=e.getPostValue()},this),n.strategy=this.get("strategy"),n},_setFieldsValues:function(e){this._updating=!0,this._receivingFields.forEach(function(n){var r=e[n],i=this._form.getField(n);if(!i){console.warn(t("Field %s does not found").s(n));return}if(r){var s=Object.keys(r).map(function(e){return{value:e,text:r[e]}});i.getFirstInput().setOptions(s)}else i.clearValue()},this),this.trigger("behavior:fieldsUpdated",this._receivingFields),this._updating=!1}});return r}),define("mobile/pages/payments/transfers/workflow/steps/second/behaviors/CalculateBehavior",["jquery","underscore","./FillBehavior"],function(e,t,n){var r=n.extend({initialize:function(){this._super(),this._queryParams=this.get("queryParams")},_handleField:function(e){var n=this._form.getField(e),r=t.debounce(this._updateReceivingFields.bind(this,n),this._updateFieldsDelay);n.on("change:value",this._onChangeField.bind(this,n,r))},_processUpdatingFieldSuccess:function(t){var n=e(t),r=n.data("data");this._setFieldsValues(r),this.trigger("behavior:calculationInfo",n)},_getQueryParams:function(e){var n=t.clone(this._queryParams);n[e.get("name")]=e.getPostValue();var r=n.additional_data={};return this._triggeringFields.forEach(function(e){r[e]=this._form.getField(e).getPostValue()},this),n},_getMethod:function(){return"post"}});return r}),define("mobile/pages/payments/transfers/workflow/steps/second/TransferDetailsStepModel",["underscore","../TransferStepModel","global_forms/Form/File/WithAjaxFilesFormModel","global/elements/ServiceManager/WithServiceManager","./behaviors/AutocompleteBehavior","./behaviors/FillBehavior","./behaviors/CalculateBehavior","global_forms/Fields/Files/FilesFieldModel"],function(e,t,n,r,i,s,o,u){var a=t.mix(n,r).extend({defaults:function(){return e.defaults({behaviors:[]},this._super())},_behaviors:{autocomplete:i,fill:s,calculate:o},_urls:function(){return e.defaults({validate:this._getService("urls").get("gtt_payment_validate_fields"),confirmationInfo:this._getService("urls").get("gtt_payment_fields_filled")},this._super())},_processFields:function(){this._super(),this._checkApplePayActiveCard(),this._initBehaviors()},_initBehaviors:function(){this.get("behaviors").forEach(this._initBehavior.bind(this))},_getFieldsConfiguration:function(){return{"*":{},client_document:{validation:["not-empty","not-correctly-file"]}}},_initBehavior:function(e){var t=this._behaviors[e.type];if(!t)throw new Error("Constructor for behavior "+e.type+"does not found");e.form=this,e.queryParams=this._workflow.get("baseInfo");var n=new t(e);n.on("all",function(){this.trigger.apply(this,arguments)},this)},_validationQuery:function(){var e={},t=this._dataToSend={additional_data:e,payment_token:this._workflow.get("paymentToken")};this.eachField(function(n){var r=n.get("name"),i;if(n.isValidationAllowed()&&!(n instanceof u)&&r!=="passport_number"){var s=n.get("data");s&&s.type==="expire_date"?(i=n.value().reverse().map(function(e){return e.length===1?"0"+e:e}).join("-"),t[r]=i):i=n.getPostValue(),e[r]=i}}),this._workflow.set("transferDetails",t),this._super({type:"post",data:t})},_sendQuery:function(e,t,n){return n=n||{},n.transport=this._transport,this._super(e,t,n)},_checkApplePayActiveCard:function(){if(this._workflow.get("srcName")==="ApplePay"&&window.ApplePaySession){var e="bWVyY2hhbnQucnUuYWxwYXJpLmFwcHM=";this._applePayActiveCard=!1,window.ApplePaySession.canMakePaymentsWithActiveCard(atob(e)).then(function(e){this._applePayActiveCard=e}.bind(this))}},setWorkflow:function(e){this.workflow=e,this._super(e.model)},save:function(){var e={src_name:this._workflow.get("srcName"),dst_name:this._workflow.get("dstName"),payment_token:this._workflow.get("paymentToken")};this._workflow.get("srcName")==="ApplePay"&&(e.apple_pay_active_card=this._applePayActiveCard);var t={type:"post",url:this._url("confirmationInfo"),data:e};return this._sendQuery("save",t),this}});return a}),define("mobile/pages/payments/transfers/workflow/steps/second/TransferDetailsError",["underscore","vendors/Backbone/Mixin","global_forms/Form/File/AjaxFilesFormError"],function(e,t,n){var r=new t({dependencies:[n]},{initialize:function(){this._messages=this.options.messages,this._super()},_fileField:"client_document",_statuses:{400:{PAYMENT_ERROR:{FIELDS_VALIDATE_ERROR:function(){var t=this._messages.fields,n=!1;e(t).each(function(e,t){var r=this._form.getField(t);if(!r)return;r.isVisible()||(n=!0),r.setValidationStatus(!1,"default")},this),this._form.focusToFirstErrorField();if(n)return;var r=this._messages.check_transfer;r&&r.length&&this._form.showNotification("errors",r[0])}}}},_codes:{PASSPORT_NUMBER_ERROR:function(){this._form.showFieldError("passport_number")}}});return r}),define("global_forms/Mixins/FieldWithAdditionalData/FieldModelWithAdditionalData",["underscore"],function(e){var t={defaults:function(){return e.extend({data:{}},this._super())},setData:function(e){this.set("data",e)}};return t}),define("mobile/pages/payments/transfers/fields/TransferFormFieldModel",["underscore","vendors/Backbone/Mixin","global_forms/Fields/Checkbox/CheckboxFieldModel","global_forms/Mixins/FieldWithAdditionalData/FieldModelWithAdditionalData"],function(e,t,n,r){var i=new t({dependencies:[r]},{_initProperties:function(){this._super(),this._childFields=null,this._valuesToShowChildren=[]},setData:function(e){this._super(e),e.constraint&&this._setConstraint(e.constraint),this instanceof n&&this._setRequired(e.required),this._valuesToShowChildren=e.valuesToShowChildren||[]},_getInputValues:function(){var e=this._super();return this.get("data").uppercase&&(e=e.map(function(e){return e.toUpperCase()})),e},_setConstraint:function(t){try{typeof t=="string"?t=new RegExp(t):e.isArray(t)&&(t=RegExp.apply(null,t))}catch(n){console.log(n)}if(!(t instanceof RegExp)){console.error("Bad constraint for field "+this.get("name")+": "+t);return}t.test("")||this.addValidationRule("not-empty");var r=this._generateCustomErrorName(),i=this.get("data");this._validator.addRule(r,function(n){return i&&i.type==="expire_date"?e.clone(n).reverse().map(function(e){return e.length===1?"0"+e:e}).join("-"):t.test(n.join(""))}),this.addValidationRule(r)},_setRequired:function(e){if(!e)return;this.addValidationRule("not-empty")},_generateCustomErrorName:function(){return"constraint_error_"+this.get("name")},setChildFields:function(e){this._childFields=e,this.link(this._toggleChildrenActivity,this)},_toggleChildrenActivity:function(){var e=this.needShowChildren();this._childFields.forEach(function(t){t.toggleValidation(e).toggleSubmittability(e)})},needShowChildren:function(){var e=this.getFirstInput().value();return this._valuesToShowChildren.length?this._valuesToShowChildren.indexOf(e)>-1:!!e}});return i}),define("global_forms/Mixins/FieldWithAdditionalData/FieldViewWithAdditionalData",[],function(){var e={_handleModel:function(){this._super(),this._updateModelData()},_updateModelData:function(){this.model.setData(this._getModelData())},_getModelData:function(){var e={};return this._getModelDataNames().forEach(function(t){e[t]=this._data[t]},this),e},_getModelDataNames:function(){return[]}};return e}),define("mobile/pages/payments/transfers/fields/TransferFormFieldView",["vendors/Backbone/Mixin","BackboneX","jquery","underscore","./TransferFormFieldModel","global_forms/Mixins/FieldWithAdditionalData/FieldViewWithAdditionalData"],function(e,t,n,r,i,s){var o=new e({dependencies:[s]},{_classes:function(){return r.defaults({hidden:"hidden"},this._super())},_initProperties:function(){this._super(),this._$childFields=null,this._form=null},beforeDecorate:function(){i.decorate(this.model)},initialize:function(){this._super(),this._updateModelData()},setForm:function(e){this._form=e,this._initChildFields()},_initChildFields:function(){var e=this._data.childFields;if(e){this._$childFields=n("."+e);var t=this._form.getFieldsInside(this._$childFields).map(function(e){return e.model});this.model.setChildFields(t),this.model.link(this._checkChildFieldsVisibility,this)}},_checkChildFieldsVisibility:function(){this._$childFields.toggleClass(this._class("hidden"),!this.model.needShowChildren()),t.trigger("change:visibility")},_getModelDataNames:function(){return this._super().concat(["childFields","valuesToShowChildren","constraint","required","error","uppercase","type"])}});return o}),define("mobile/pages/payments/transfers/workflow/steps/additional/TransferAdditionalStepModel",["underscore","../TransferStepModel","global_forms/Form/File/WithAjaxFilesFormModel","global/elements/ServiceManager/WithServiceManager"],function(e,t,n,r){var i=t.mix(n,r).extend({});return i}),define("FormClasses/Rules/fileFieldValidationRules",["global_forms/Fields/Files/FilesFieldModel"],function(e){var t=e.getValidator();return t.addExtensionAndSizeValidationRule("not-correctly-file",["gif","jpg","jpeg","tiff","png","doc","docx","pdf"],5e6),t}),define("mobile/pages/payments/transfers/workflow/steps/additional/TransferAdditionalStepView",["underscore","../TransferStepView","global_forms/Form/File/WithAjaxFilesFormView","./TransferAdditionalStepModel","mobile/pages/payments/transfers/fields/TransferFormFieldView","../WithNotifications","FormClasses/Rules/fileFieldValidationRules"],function(e,t,n,r,i,s){var o=t.mix(s,n).extend({initialize:function(){this._super(),this.eachField(function(e){i.decorate(e),e.setForm(this)},this),this._init()},_ModelConstructor:r,_submitName:"send",_init:function(){this.model.postUrl=this.getField("post_url").value()[0],this.model.callbackUrl=this.getField("callback_url").value()[0],this.model.getFilesUrl=this._getService("urls").get("gtt_payment_get_fields"),this.model.clientId=this.getField("client_id").value()[0],this.model.cardField=this.getField("skr_destinationCardNumber");var e=this},enableSubmitButton:function(){var e=this.getField(this._submitName);return e&&e.$el.removeClass("button_status_loading"),this},disableSubmitButton:function(){var e=this.getField(this._submitName);return e&&e.$el.addClass("button_status_loading"),this},setParameters:function(e,t){this.model.workflow=e,this.model.data=t},_sendForm:function(){var t=this.model.formFields.models.filter(function(e){return e.attributes.name?e.attributes.name.match(/skr_.*/):!1}),n={};t.forEach(function(e){n[e.attributes.name]=e.value()[0]}),$.ajax({url:this.model.postUrl,type:"POST",dataType:"json",data:n}).done(e.bind(function(t){if(t.storeCard&&t.storeCard.reason&&t.storeCard.reason==="cardinvalid"){this.model.cardField.setValidationStatus(!1,"default"),this.enableSubmitButton();return}$.ajax({url:this.model.callbackUrl,type:"POST",data:{response:t,clientId:this.model.clientId}}).done(e.bind(function(){$.ajax({url:this.model.getFilesUrl,type:"GET",data:Object.assign(this.model.data,{from_cache:!1})}).done(e.bind(function(e){this.model.workflow.refreshDetailsStep(e)},this)).always(e.bind(function(){this.enableSubmitButton()},this))},this)).fail(e.bind(function(){this.showNotification("errors"),this.enableSubmitButton()},this))},this)).fail(e.bind(function(){this.enableSubmitButton(),this.showNotification("errors")},this))}});return o}),define("mobile/pages/payments/transfers/workflow/steps/second/TransferDetailsStepView",["underscore","../TransferStepView","global_forms/Form/File/WithAjaxFilesFormView","./TransferDetailsStepModel","./TransferDetailsError","mobile/pages/payments/transfers/fields/TransferFormFieldView","../additional/TransferAdditionalStepView","../WithNotifications","FormClasses/Rules/fileFieldValidationRules"],function(e,t,n,r,i,s,o,u){var a=t.mix(u,n).extend({_initProperties:function(){this._super(),this._clearFileFieldOnSubmit=!1},initialize:function(){this._super(),this._setModelData(),this.eachField(function(e){s.decorate(e),e.setForm(this)},this)},_selectors:function(){return e.defaults({note:".js-calculate-info",additionalButton:".js-additional-fields",additionalContainer:".js-additional-form-container",additionalClose:".js-additional-fields-close",additionalSubmit:".js-additional-fields-submit"},this._super())},events:function(){var e=this._super();return e["click "+this._selector("additionalButton")]=this._onAdditionalButtonClick,e["click "+this._selector("additionalClose")]=this._onAdditionalCloseClick,e["click "+this._selector("additionalSubmit")]=this._onAdditionalSubmitClick,e},_fileFieldName:"client_document",_ModelConstructor:r,_getErrorMixins:function(){return this._super().concat([i])},_initHandlers:function(){this._super(),this.model.on("behavior:calculationInfo",this._updateCalculationInfo,this).on("behavior:fieldsUpdated",this._onBehaviorComplete,this).on("behavior:error",this._onBehaviorComplete,this).on("behavior:fieldsRequest",this._loadFields,this).on("validate:success",this._processValidationSuccess,this)},_setModelData:function(){e(this._data.data).each(function(e,t){this.model.set(t,e)}.bind(this))},_updateCalculationInfo:function(e){this._elem("note").replaceWith(e),this._dropElemCache("note")},_onBehaviorComplete:function(e){e.forEach(function(e){this.getField(e).stopLoading().status.show("check")},this),this.enableSubmitButton()},_loadFields:function(e){e.forEach(function(e){this.getField(e).load()},this),this.disableSubmitButton()},_processValidationSuccess:function(e){this._processTransferWarnings(e)},_onAdditionalButtonClick:function(t){if(this.additionalDataIsLoaded)$(this._elem("additionalContainer")[0]).slideDown(300),$(this._elem("additionalButton")[0]).hide();else{$(t.target).addClass("button_status_loading");const n={payment_token:this.model._workflow.get("paymentToken"),src_account:this.model._workflow.get("baseInfo").src_account,dst_account:this.model._workflow.get("baseInfo").dst_account,isBankTransfer:this.model._workflow.get("isBankTransfer"),src_name:this.model._workflow.get("srcName"),dst_name:this.model._workflow.get("dstName"),src_method_description:this.model._workflow.get("src_method_description")},r=this.model.workflow;$.ajax({url:this._getService("urls").get("gtt_payment_get_additional_fields"),data:n}).done(e.bind(function(e){var i=$(this._elem("additionalContainer")[0]);i.html(e),i.slideDown(300),$(t.target).hide(),this.additionalForm=new o({el:i[0]}),this.additionalForm.setParameters(r,n),this.additionalDataIsLoaded=!0},this)).fail(e.bind(function(){},this)).always(function(){$(t.target).removeClass("button_status_loading")})}},_onAdditionalCloseClick:function(){$(this._elem("additionalContainer")[0]).slideUp(300),$(this._elem("additionalButton")[0]).show()},_onAdditionalSubmitClick:function(e){this.additionalForm._submit(e)},_submit:function(e){if(this.model.get("scenario")==="warnings"){e.preventDefault(),this._loadSubmitButton(),this.model.save();return}this._super(e)}});return a}),define("mobile/pages/payments/transfers/workflow/steps/third/ConfirmInfoStepModel",["Backbone","underscore","jquery","../TransferStepModel","global_forms/Fields/FormField/FormFieldsCollection"],function(e,t,n,r,i){var s=r.extend({defaults:function(){return t({scenario:"processTransfer"}).defaults(this._super())},_initProperties:function(){this._super(),this._$form=null,this.applePaySession=null,this.currenciesMap={643:"RUB",840:"USD",978:"EUR"}},initialize:function(){this._super(),this.on("getFilledFields:success",this._processFilledFields.bind(this)),e.on("ApplePayClick",this._applePayHandler,this)},_applePayHandler:function(){var e={total:{label:"Alpari",amount:this._workflow.attributes.src_amount},countryCode:"RU",currencyCode:this.currenciesMap[this._workflow.attributes.sourceCurrency],merchantCapabilities:["supports3DS"],supportedNetworks:["masterCard","visa"]};this.applePaySession=new ApplePaySession(2,e),this.applePaySession.onvalidatemerchant=this._onValidateMerchant.bind(this),this.applePaySession.onpaymentauthorized=this._onPaymentAuthorized.bind(this),this.applePaySession.begin()},_onValidateMerchant:function(e){var t=this,r=e.validationURL;n.ajax({type:"POST",url:t._url("appleValidateMerchant"),data:{validationUrl:r},success:function(e){t.applePaySession.completeMerchantValidation(e.data)},error:function(e){}})},_onPaymentAuthorized:function(e){var t=this;this._workflow.get("transferDetails").additional_data.transaction_payment_token=btoa(JSON.stringify(e.payment.token.paymentData)),n.ajax({type:"POST",url:t._url("appleCreateTransfer"),data:{paymentToken:t._workflow.get("transferDetails").payment_token,additionalData:t._workflow.get("transferDetails").additional_data},success:function(e){t.applePaySession.completePayment(ApplePaySession.STATUS_SUCCESS),n('form[name="confirmation"]').submit()},error:function(e){return t.applePaySession.abort()}})},_getFieldsConfiguration:function(){return t({templateName:{validation:["not-empty","maxLength50"]}}).defaults(this._super())},_queries:function(){return t.defaults({getFilledFields:this._getFilledFieldsQuery},this._super())},_urls:function(){var e=this._getService("urls");return t.defaults({getFilledFields:e.get("gtt_payment_get_server_fields"),appleValidateMerchant:e.get("gtt_payment_apple_pay_validate_merchant"),appleCreateTransfer:e.get("gtt_payment_apple_pay_create_transfer")},this._super())},_getFilledFieldsQuery:function(){var e={src_info:this._workflow.get("srcInfo"),dst_info:this._workflow.get("dstInfo"),payment_token:this._workflow.get("paymentToken")},t=this.getField("confirmCode"),r=this.getField("code"),i=n("form[name="+this.get("name")+"]").find("input[name='code']").val();t&&(e.confirmCode=t.getPostValue()),r?e.code=r.getPostValue():i&&(e.code=i),this._sendQuery("getFilledFields",{data:e})},_processFilledFields:function(e){this._prepareForm(e.serverFields);var t=this._workflow.attributes.dst_amount,n=this._workflow.attributes.transferType,r=this._workflow.attributes.source;this._processTransfer()},_prepareForm:function(e){var r=this._$form=n("<form/>").prop({method:e.redirectMethod,action:e.redirectUrl}).css({display:"none"});t.each(e.fields,function(e,i){t.isArray(e)?e.forEach(function(e){n('<input type="hidden"/>').prop({name:i+"[]",value:e}).appendTo(r)}):n('<input type="hidden"/>').prop({name:i,value:e}).appendTo(r)})},_processSavingTemplateSuccess:function(){this.get("scenario")=="saveTemplate"&&this._getService("urls").goTo("gtt_payment_transfers")},_processSavingTemplateComplete:function(){this.get("scenario")=="processTransfer"&&this._processTransfer()},_processTransfer:function(){this._$form.appendTo("body").submit()}});return s}),define("mobile/pages/payments/transfers/workflow/steps/third/ConfirmInfoStepView",["Backbone","underscore","jquery","../TransferStepView","./ConfirmInfoStepModel"],function(e,t,n,r,i){var s=r.extend({_classes:function(){return t.defaults({applePayButton:"apple-pay-btn"},this._super())},_initProperties:function(){this._super(),this._ignoreAllAjaxErrors=!1},events:function(){var e=this._super();return e["click "+this._selector("applePayButton")]=this._applePayClick,e},_applePayClick:function(t){t.preventDefault(),e.trigger("ApplePayClick")},_initHandlers:function(){this._super(),this.model.on("query:Infrequest",this._processQueryRequest,this).on("query:error",this._processQueryError,this).on("save:request",this._onSaveRequest,this).on("getFilledFields:error",this._processSaveError,this)},_ModelConstructor:i,_getCaptchaUrl:function(){return this._getService("urls").get("gtt_payment_captcha")},_sendForm:function(){this.model.set("scenario","processTransfer").query("getFilledFields")},_processQueryRequest:function(){this._ignoreAllAjaxErrors=!1},_getErrorParams:function(e,n){return t({ignoreErrors:this._ignoreAllAjaxErrors}).defaults(this._super(e,n))},_processQueryError:function(e,t){Object.keys(this.classDynamicConfirmationCode).length>0&&(this.classDynamicConfirmationCode.clearInputCodeConfirmation(),this.classDynamicConfirmationCode.closeErrorTooltips(),this.classDynamicConfirmationCode.triggerError(e,t));if(this._ignoreAllAjaxErrors)return;this.enableSubmitButton()},_onSaveRequest:function(){this.done()},leave:function(){this._super(),this.enableSubmitButton()},_submit:function(e){var t=this.model._workflow.attributes.transferType,n=t+"_confirm_transfer_funds_clicked";window.mParticle&&window.mParticle.logEvent(n,window.mParticle.EventType.Other),this._super(e)}});return s}),define("mobile/pages/payments/transfers/workflow/steps/third/WithSendCode",["vendors/Backbone/Mixin","global_forms/Form/FormWithBlockingBruteForceVerification/BlockingBruteForceVerificationView","global_forms/Form/Verification/VerificationModel","mobile/pages/payments/transfers/workflow/steps/third/ConfirmInfoStepModel"],function(e,t,n,r){var i=new e({dependencies:[t]},{_ModelConstructor:r.mix(n)});return i}),define("mobile/FormClasses/Inputs/Select/DynamicSelectInputView",["underscore","jquery","global_forms/Inputs/SimpleSelect/SimpleSelectInputView"],function(e,t,n){var r=n.extend({_classes:function(){return e.defaults({loading:"select_state_loading"},this._super())},startLoading:function(){return this.disable(),this.$el.addClass(this._class("loading")),this},stopLoading:function(){return this.enable(),this.$el.removeClass(this._class("loading")),this},updateFrom:function(e){var n=t(e),r=this.model.value();return this._$startInput=null,this.$input.html(n.find(".js-form-el__input").html()),this.trigger("toggleEnabled",this,!this._hasClass("disabled",n)),this._dropElemCache(),this._data=n.data(),this._updateModelData(),this.model.get("allowedValues").indexOf(r)>-1?this._setValue(r):this.model.setDefaultValue(this._data["default"]),this},getData:function(e){return this._data[e]||null}});return r}),define("mobile/pages/payments/transfers/workflow/TransfersWorkflowView",["underscore","global/WorkflowClasses/WorkflowView","./steps/first/BaseInfoStepView","./steps/second/TransferDetailsStepView","./steps/third/ConfirmInfoStepView","global_forms/Form/Verification/VerificationView","mobile/pages/payments/transfers/workflow/steps/third/WithSendCode","global_forms/Inputs/inputsFactory","mobile/FormClasses/Inputs/Select/DynamicSelectInputView"],function(e,t,n,r,i,s,o,u,a){u.addProduct("DynamicSelectInput",a);var f=t.extend({initialize:function(){this._super();var e=this._data.validateDirection;if(e&&e.warnings&&e.warnings.length){var t=this._steps[0];t.model.set("scenario","fulfilled"),t.processValidationSuccess(e)}},_classes:function(){return e.defaults({basicInfoForm:"js-form-basic-info",detailsForm:"js-form-details",confirmationForm:"js-form-confirmation"},this._super())},_updateModelData:function(){this.model.set("paymentToken",this._data.paymentToken)},_initTabs:function(){this._tabs.on("change:after",this._correctStepFocus,this)},_correctStepFocus:function(){var e=this.getCurrentStep();e&&e.correctFocus()},_getStep:function(e){var t;switch(e){case 0:return t=new n({workflow:this,el:this._elem("basicInfoForm"),page:this._page}),t.model.setWorkflow(this.model),t;case 1:return t=new r({el:this._elem("detailsForm")}),t.model.setWorkflow(this),t;case 2:var u=i.mix(o),a=s.hasConfirmCode.call(u,this._elem("confirmationForm")),f=a?u:i;return t=new f({el:this._elem("confirmationForm"),page:this._page}),t.model.setWorkflow(this.model),t}return null},_getSteps:function(){var e=[],t;for(var n=0;n<=this._currentStepIndex;n++)t=this._getStep(n),n!==this._currentStepIndex&&t.model.onSkip(),e.push(t);return e},_onStepPerformed:function(e,t){var n=this._steps.indexOf(e);switch(n){case 0:this._tabs.getTabEl("details").html(t),this._dropElemCache("detailsForm"),this._steps[1]=this._getStep(1),this._initStep(this._steps[1],1);break;case 1:this._tabs.getTabEl("confirmation").html(t),this._dropElemCache("confirmationForm"),this._steps[2]=this._getStep(2),this._initStep(this._steps[2],2)}this._super(e,t)},refreshDetailsStep:function(e){this._tabs.getTabEl("details").html(e),this._dropElemCache("detailsForm"),this._steps[1]=this._getStep(1),this._initStep(this._steps[1],1)}});return f}),define("global/WorkflowClasses/WorkflowTabs",["jquery","underscore","global/elements/Tabs/Tabs","global/Anchor/Anchor","vendors/jquery/plugins/jquery.focusable"],function(e,t,n,r){var i=n.extend({_classes:function(){return t.defaults({disabled:""},this._super())},_selectors:function(){return t.defaults({firstFocusable:":focusable:first"},this._super())},_onTabClick:function(t){var n=e(t.currentTarget).closest(this._selector("headerItem"));n.hasClass(this._class("disabled"))?t.preventDefault():this._super(t)},showTab:function(e,t){this._super(e,t),this._setAnchor(e,t),this._setFocusInsideActiveTab()},_setAnchor:function(e,t){this.$activeTab=this.getActiveTabEl();var n=this._getTabsHeaderItem(e,t),i=n.find(this._selector("control"))[0].href.split("#")[1],s=i.split("=");s.length===2&&r.set(s[0],s[1])},_setFocusInsideActiveTab:function(){var t=this.$activeTab.find(this._selector("firstFocusable"));t.focus();if(t.length){var n=t[0].getBoundingClientRect();(n.top<0||n.bottom>this._$window.height())&&e.scrollTo(this.$activeTab)}},show:function(e){this.showTab(e,this._getLinkEl(e))},enableTab:function(e){this._getTabsHeaderItem(e).removeClass(this._class("disabled"))},disableTab:function(e){this._getTabsHeaderItem(e).addClass(this._class("disabled"))},disable:function(){return this._elem("headerItem").addClass(this._class("disabled")),this},enable:function(){return this._elem("headerItem").removeClass(this._class("disabled")),this}});return i}),define("mobile/elements/Tabs/TransferTabs",["jquery","underscore","global/WorkflowClasses/WorkflowTabs"],function(e,t,n){var r=n.extend({_classes:function(){return t.defaults({activeHeaderItem:"transfers__tab_active_yes",activeBlocksItem:"transfers__panel_active_yes",disabled:"transfers__tab_active_no"},this._super())},_selectors:function(){return t.defaults({control:".transfers__tab-control",headerItem:".transfers__tab",blocksItem:".transfers__panel",activeControl:".transfers__panel_active_yes .transfers__tab-control"},this._super())},getTabEl:function(e){var t=this._getTabsHeaderItem(e),n=this._elem("blocksItem"),r=t.index();return n.eq(r)}});return r}),define("mobile/elements/Tabs/TransferTabsManager",["underscore","global/elements/Tabs/TabsManager","./TransferTabs"],function(e,t,n){var r=t.extend({_TabsClass:n,_classes:function(){return e.defaults({tabs:"transfers"},this._super())},_selectors:function(){return e.defaults({control:'.transfers__tab-control[href="#%s"]'},this._super())}});return r}),require(["underscore","jquery","global/PageClasses/ProjectPage","mobile/pages/payments/transfers/TransfersRouter","mobile/pages/payments/transfers/workflow/TransfersWorkflowModel","mobile/pages/payments/transfers/workflow/TransfersWorkflowView","mobile/elements/Tabs/TransferTabsManager"],function(e,t,n,r,i,s,o){return n.extend({_selectors:function(){return e.defaults({notificationTransfer:".js-notification-transfer"},this._super())},_classes:function(){return e.defaults({workflow:"transfers"},this._super())},_initProperties:function(){this._super(),this._workflow=null,this._router=null,this._transferTabsManager=null,this._isApplePayAvailable=!1},initialize:function(){this._super(),this._initTransferTabsManager(),this._initWorkflow(),this._initRouter(),this._initQRCode(),this._elem("notificationTransfer").length&&this._sendTransferInfo(),this._initApplePay()},_initQRCode:function(){var e=document.getElementById("qrcode");if(e){var n=t(e).attr("data-url");if(n){var r=t(e).attr("data-width"),i=t(e).attr("data-height"),s={text:n,width:typeof r=="undefined"?94:r,height:typeof i=="undefined"?94:i,correctLevel:t(e).attr("data-correct-level")},o=new QRCode(e,s),u=parseInt(t(e).attr("data-render-download-link"))===1;u&&o.renderDownloadLink(t(e).attr("data-download-link-text"),t(e).attr("data-download-link-filename"))}}},_initTransferTabsManager:function(){this._transferTabsManager=new o({el:this.el})},_initWorkflow:function(){var e=this._transferTabsManager.collection[0];this._workflow=new s({el:this._elem("workflow"),model:new i,tabs:e,currentStep:e.getActiveTabNumber(),page:this})},_initRouter:function(){this._router=new r({workflow:this._workflow})},_initApplePay:function(){window.ApplePaySession&&(this._isApplePayAvailable=window.ApplePaySession.canMakePayments)},_sendTransferInfo:function(){var e=this._elem("notificationTransfer").data();if(e.result)try{fbq("track","Purchase")}catch(t){}}})}),define("108bb54bf2c5710c6e6114a960397d35",function(){});